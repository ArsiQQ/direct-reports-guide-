# Настройка автоматических отчетов Яндекс.Директ (~15 минут)

## Перед началом: установите редактор кода

На шаге 4 вам понадобится открыть и отредактировать файл `script_v3_monthly.js`. Для этого нужен редактор кода.

**Рекомендуемые варианты:**   

| Редактор | Для кого | Ссылка |
|---|---|---|
| **Notepad++** | Самый простой, для новичков | https://www.softportal.com/get-5406-notepad.html |
| **VS Code** | Универсальный, популярный среди разработчиков | https://code.visualstudio.com/ |
| **Sublime Text** | Лёгкий и быстрый | https://www.sublimetext.com/download |

> Если вы никогда не работали с кодом — берите **Notepad++**. Он бесплатный, устанавливается за минуту, интерфейс на русском.

---

## Шаг 1. Создать OAuth-приложение

1. Авторизуйтесь в Яндекс-аккаунте, с которого будет собираться статистика.
2. Перейдите на https://oauth.yandex.ru/
3. Нажмите **Создать первое приложение**.
4. Выберите **«Подключить авторизацию через Яндекс ID на вашем сервисе»** → **Создать**.
5. На вопрос «Какое приложение хотите создать?» выберите **«Для доступа к API или отладки»** → **Перейти к созданию**.
6. Заполните форму:
   - **Название сервиса:** `Автоматический отчёт`
   - **Доступ к данным:** выберите `direct:api` (Использование API Яндекс.Директа)
7. Нажмите **Создать приложение**.
8. На запрос верификации через Госуслуги — закройте окно, это не нужно.
9. Пролистайте вниз — там будут две строки:

| Поле | Пример значения |
|---|---|
| `ClientID` | `3455578e3a5b4be584fd68b21970c330` |
| `Client secret` | `72259d1a9a4b403f937d6b760a9a80a2` |

> ⚠️ **Вкладку не закрывайте** — значения понадобятся на шаге 3.
>
> Если закрыли случайно: снова откройте https://oauth.yandex.ru/ и кликните на строку **«Автоматический отчет»**.

---

## Шаг 2. Получить код подтверждения

1. Возьмите ваш `ClientID` из шага 1.
2. Откройте в браузере ссылку, подставив свой `ClientID`:

```
https://oauth.yandex.ru/authorize?response_type=code&client_id=ВАШ_CLIENT_ID
```

Пример:
```
https://oauth.yandex.ru/authorize?response_type=code&client_id=3455578e3a5b4be584fd68b21970c330
```

3. Нажмите **Продолжить** на предупреждении о верификации.
4. Выберите **«Войти как (ваш логин)»**.
5. Вас перебросит на страницу с кодом подтверждения. Он выглядит примерно так:

```
ejt3o4cgliy43j56
```

> ⚠️ **Сохраните этот код** — он понадобится на шаге 3. Код действует ограниченное время!

---

## Шаг 3. Получить access_token через терминал для MacOS и Windows

**Что подставить:**

| Плейсхолдер | Откуда взять | Пример |
|---|---|---|
| `КОД_ОТ_КЛИЕНТА` | Шаг 2 | `ejt3o4cgliy43j56` |
| `ВАШ_CLIENT_ID` | Шаг 1 | `3455578e3a5b4be584fd68b21970c330` |
| `ВАШ_CLIENT_SECRET` | Шаг 1 | `72259d1a9a4b403f937d6b760a9a80a2` |

---

### MacOS

1. Откройте **Терминал** (Finder → Программы → Утилиты → Терминал).
2. Соберите команду, подставив свои данные, и вставьте её целиком:

```bash
curl -X POST \
  -d "grant_type=authorization_code" \
  -d "code=КОД_ОТ_КЛИЕНТА" \
  -d "client_id=ВАШ_CLIENT_ID" \
  -d "client_secret=ВАШ_CLIENT_SECRET" \
  https://oauth.yandex.ru/token
```

Пример готовой команды:

```bash
curl -X POST \
  -d "grant_type=authorization_code" \
  -d "code=ejt3o4cgliy43j56" \
  -d "client_id=3455578e3a5b4be584fd68b21970c330" \
  -d "client_secret=72259d1a9a4b403f937d6b760a9a80a2" \
  https://oauth.yandex.ru/token
```

Выделите все 6 строк, скопируйте и вставьте в Терминал.

---

### Windows

1. Нажмите `Win + R`, введите `cmd` и нажмите **Enter**.
2. На Windows команда вставляется **одной строкой** (без обратных слешей `\`):

```
curl -X POST -d "grant_type=authorization_code" -d "code=КОД_ОТ_КЛИЕНТА" -d "client_id=ВАШ_CLIENT_ID" -d "client_secret=ВАШ_CLIENT_SECRET" https://oauth.yandex.ru/token
```

Пример готовой команды:

```
curl -X POST -d "grant_type=authorization_code" -d "code=ejt3o4cgliy43j56" -d "client_id=3455578e3a5b4be584fd68b21970c330" -d "client_secret=72259d1a9a4b403f937d6b760a9a80a2" https://oauth.yandex.ru/token
```

Скопируйте строку целиком и вставьте в cmd (`Ctrl+V` или правая кнопка мыши → Вставить).

### Возможные результаты

**Ошибка** — код подтверждения истёк:
```json
{"error":"invalid_grant","error_description":"Code has expired"}
```
→ Вернитесь на шаг 2 и получите новый код.

**Успех** — вы увидите:
```json
{
  "access_token": "y1__xC02s7WCBjm9j0g0uipuhZ-1xH-FxP9OdUTc6DsCxahU1cFaA",
  "expires_in": 31527000,
  "refresh_token": "2:AAA:...",
  "token_type": "bearer"
}
```

> ✅ Из этого ответа нужен только **`access_token`**. Сохраните его — это **ВАШ ТОКЕН**.

---

## Шаг 4. Настроить скрипт

Откройте файл `script_v3_monthly.js` и внесите изменения:

**Строка 4** — вставьте ВАШ ТОКЕН:
```js
accessToken: "ВАШ_ТОКЕН_ЗДЕСЬ",
```

**Строка 7** — укажите ID целей из Яндекс.Метрики (Метрика → Цели → Номер цели):
```js
goalIds: [256213158, 323319824],
```

**Строки 11–14** — добавьте названия целей (они отобразятся в отчёте):
```js
goalNames: {
  256213158: "Отправка формы - URL",
  323319824: "Переход в мессенджер",
},
```

Сохраните файл.

---

## Шаг 5. Создать Google Таблицу и добавить скрипт

1. Создайте новую таблицу на https://docs.google.com/
2. В меню выберите **Расширения → Apps Script**.
3. Удалите стандартный код `function myFunction() { }`.
4. Вставьте весь код из файла `script_v3_monthly.js`.
5. Нажмите **Сохранить** (`Cmd+S` / `Ctrl+S`).
6. При желании дайте проекту название.

---

## Шаг 6. Настроить автоматический триггер

1. В панели слева найдите значок **будильника** (Триггеры).
2. Нажмите **Добавить триггер** и настройте:

| Параметр | Значение |
|---|---|
| Функция | `UpdateDailyReport` |
| Источник события | Триггер по времени |
| Тип триггера | По дням |
| Время | с 09:00 до 10:00 |

3. Нажмите **Сохранить**.
4. Откроется предупреждение — нажмите **Дополнительно** (Advanced) → **Go to Проект (unsafe)**.
5. В новом окне поставьте галочки если требуется → **Allow**.

---

## Шаг 7. Подать заявку на доступ к API Яндекс.Директа

1. Откройте https://direct.yandex.ru/
2. В левой панели: **Инструменты → API**.
3. Нажмите **Получить доступ к API** → поставьте галочку **Согласен** → **Принять соглашение**.
4. Перейдите на вкладку **Заявки → Новая заявка → Полный доступ**.
5. Заполните форму:

| Поле | Что указать |
|---|---|
| Контакт | Ваш логин в Директе |
| Специфика работы | Прямой заказчик |
| Язык программирования | JavaScript + JSON |
| Логины для примера | Ваш логин в Директе |
| Для чего приложение | Автоматизировать регулярную работу по управлению кампаниями в Директе |
| Основные функции | Получение статистики и отчетов |

**Поле «Новые возможности»** — скопируйте текст ниже:
```
Автоматическая ежедневная выгрузка статистики рекламных кампаний в Google Таблицы
для удобного анализа и мониторинга эффективности рекламы. Позволяет клиентам видеть
актуальные данные по показам, кликам, расходу и конверсиям без необходимости вручную
заходить в интерфейс Директа.
```

**Поле «Схема взаимодействия»** — скопируйте текст ниже:
```
Приложение через OAuth получает токен доступа к API Яндекс.Директа.
Ежедневно по расписанию отправляет запросы к Reports API для получения статистики.
Полученные данные автоматически записываются в Google Таблицу клиента.
Приложение работает на базе Google Apps Script (серверная автоматизация).
Не хранит данные на сторонних серверах, вся информация поступает напрямую в таблицу клиента.

СПЕЦИФИКАЦИЯ ПРИЛОЖЕНИЯ "Direct Reports Integration"

1. НАЗНАЧЕНИЕ
Автоматическая выгрузка статистики из Яндекс.Директа в Google Таблицы

2. ТЕХНОЛОГИИ
- Google Apps Script (JavaScript)
- Яндекс.Директ Reports API (JSON)
- OAuth 2.0 для авторизации

3. ОСНОВНЫЕ ФУНКЦИИ
- Ежедневное получение статистики по кампаниям
- Автоматическая запись данных в Google Таблицы
- Форматирование отчетов (валюта, проценты, числа)
- Обновление существующих записей при повторном запуске

4. ПОЛУЧАЕМЫЕ МЕТРИКИ
- Дата
- Показы (Impressions)
- Клики (Clicks)
- Расход с НДС (Cost)
- CTR
- Средняя цена клика (AvgCpc)
- Конверсии по выбранным целям
- Цена конверсии (CPA)

5. СХЕМА РАБОТЫ
[OAuth токен] → [Google Apps Script] → [Яндекс.Директ API] → [Обработка данных] → [Google Sheets]

6. БЕЗОПАСНОСТЬ
- Токены хранятся только в защищенном окружении Google Apps Script
- Прямая передача данных без промежуточных серверов
- Данные доступны только владельцу Google Таблицы

7. ЧАСТОТА ОБНОВЛЕНИЙ
Ежедневно в заданное время (настраивается через триггеры Google Apps Script)

8. ПРЕИМУЩЕСТВА ДЛЯ ПОЛЬЗОВАТЕЛЕЙ
- Экономия времени на ручной выгрузке отчетов
- Актуальные данные всегда под рукой
- Возможность строить дополнительные графики и аналитику в Google Таблицах
- Совместный доступ к отчетам для команды
- Бесплатное решение без дополнительных сервисов

9. ОГРАНИЧЕНИЯ API
- Соблюдение лимитов запросов Яндекс.Директ API
- Использование только разрешенных методов Reports API
- Запросы только к собственным аккаунтам или аккаунтам с предоставленным доступом

10. ПОДДЕРЖКА
- Документация в виде комментариев в коде
- Логирование всех операций для диагностики
- Обработка ошибок API и уведомление пользователя
```

**Поле «Спецификации»** — прикрепите файл `specification.txt`.

6. Нажмите **Согласен → Отправить**.

> ⏳ Обычно заявку одобряют в течение **3–6 часов**. В редких случаях может занять до **1–3 рабочих дней**.
>
> ⚠️ Если заявку **отклонили** — не расстраивайтесь. Подайте повторно, указав в поле «Схема взаимодействия» полную спецификацию выше (она специально расширена для таких случаев).

---

## Шаг 8. Первая выгрузка данных (после одобрения заявки)

1. Вернитесь в Apps Script вашей таблицы.
2. В выпадающем списке функций выберите **`loadCurrentMonth`**.
3. Нажмите **Выполнить**.

После этого в таблице появится лист с данными за текущий месяц. Далее триггер будет обновлять отчёт автоматически каждый день.

---

## Шаг 9. Открыть доступ клиенту

В настройках таблицы откройте доступ: **«Всем, у кого есть ссылка» → Только чтение**.

Отправьте ссылку клиенту.

---

## Итоговый чеклист

- [ ] Создано OAuth-приложение, сохранены `ClientID` и `Client secret`
- [ ] Получен код подтверждения
- [ ] Получен `access_token`
- [ ] Настроен файл `script_v3_monthly.js` (токен, ID целей, названия целей)
- [ ] Создана Google Таблица, вставлен скрипт
- [ ] Настроен ежедневный триггер (`UpdateDailyReport`, 09:00–10:00)
- [ ] Подана заявка на доступ к API Яндекс.Директа
- [ ] После одобрения: запущена первая выгрузка (`loadCurrentMonth`)
- [ ] Клиенту открыт доступ на чтение в Google Таблице
- [ ] Клиенту отправлена ссылка на таблицу
